#!/usr/bin/env node
'use strict';

Object.defineProperty(exports, '__esModule', {
    value: true
});
exports.enhanceFile = enhanceFile;

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { 'default': obj }; }

require('babel/polyfill');

var _jsYaml = require('js-yaml');

var _jsYaml2 = _interopRequireDefault(_jsYaml);

var _gracefulFs = require('graceful-fs');

var _gracefulFs2 = _interopRequireDefault(_gracefulFs);

var _libParseHansonString = require('../lib/parse-hanson-string');

var _lodashObjectMapValues = require('lodash/object/mapValues');

var _lodashObjectMapValues2 = _interopRequireDefault(_lodashObjectMapValues);

var _lodashCollectionForEach = require('lodash/collection/forEach');

var _lodashCollectionForEach2 = _interopRequireDefault(_lodashCollectionForEach);

var _lodashObjectKeys = require('lodash/object/keys');

var _lodashObjectKeys2 = _interopRequireDefault(_lodashObjectKeys);

var _lodashCollectionIncludes = require('lodash/collection/includes');

var _lodashCollectionIncludes2 = _interopRequireDefault(_lodashCollectionIncludes);

var _humanizeList = require('humanize-list');

var _humanizeList2 = _interopRequireDefault(_humanizeList);

function isReqName(name) {
    return /^([A-Z]|[0-9][A-Z0-9\- ])/.test(name);
}

function loadFile(filename) {
    var data = _gracefulFs2['default'].readFileSync(filename, 'utf-8');
    var object = _jsYaml2['default'].safeLoad(data);
    return object;
}

function writeFile(filename, data) {
    _gracefulFs2['default'].writeFileSync(filename, data);
}

var declaredVariables = {};

function enhanceFile(data) {
    var _ref = arguments[1] === undefined ? {} : arguments[1];

    var _ref$topLevel = _ref.topLevel;
    var topLevel = _ref$topLevel === undefined ? false : _ref$topLevel;

    // 1. adds 'result' key, if missing
    // 2. parses the 'result' and 'filter' keys
    // 3. warns if it encounters any lowercase keys not in the whitelist

    var keys = keys(data);
    var baseWhitelist = ['result', 'message', 'declare'];
    var topLevelWhitelist = baseWhitelist.concat(['name', 'revision', 'type']);
    var lowerLevelWhitelist = baseWhitelist.concat(['filter', 'message', 'description']);
    var whitelist = topLevel ? topLevelWhitelist : lowerLevelWhitelist;

    keys.forEach(function (key) {
        if (!isReqName(key) && !whitelist.includes(key)) {
            console.warn('only ' + (0, _humanizeList2['default'])(whitelist) + ' keys are allowed, and "' + key + '" is not one of them. all requirements must begin with an uppercase letter or a number.');
        }
    });

    if ('declare' in data) {
        (0, _lodashCollectionForEach2['default'])(data.declare, function (value, key) {
            declaredVariables[key] = value;
        });
    }

    var mutated = (0, _lodashObjectMapValues2['default'])(data, function (value, key) {
        if (typeof value === 'string' && isReqName(key)) {
            value = { result: value };
        }

        if (isReqName(key)) {
            value = enhanceFile(value, { topLevel: false });
            value['$type'] = 'requirement';
        } else if (key === 'result' || key === 'filter') {
            (0, _lodashCollectionForEach2['default'])(declaredVariables, function (contents, name) {
                if ((0, _lodashCollectionIncludes2['default'])(value, '$' + name)) {
                    console.log('replacing ' + ('$' + name) + ' with ' + contents);
                    // const rex = new RegExp(, 'g')
                    value = value.split('$' + name).join(contents);
                }
            });

            try {
                value = (0, _libParseHansonString.parse)(value);
            } catch (e) {
                console.error(e.message);
                console.error('(in "' + value + '")');
            }
        }

        return value;
    });

    if ('declare' in data) {
        (0, _lodashCollectionForEach2['default'])(data.declare, function (value, key) {
            delete declaredVariables[key];
        });
    }

    return mutated;
}

function main() {
    var filename = process.argv[2];
    var outfile = process.argv[3] || filename.replace(/.yaml$/, '.json');
    if (!filename) {
        console.log('usage: ' + process.argv[1].split('/').slice(-1) + ' infile [outfile]');
        return;
    }
    var data = loadFile(filename);
    var mutated = enhanceFile(data, { topLevel: true });
    writeFile(outfile, JSON.stringify(mutated, null, 2));
}

main();

